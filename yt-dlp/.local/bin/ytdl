#!/bin/sh
#
# AUTHOR: Simon H Moore
#
# DATE: Fri Jan 14 2022
#
# DESC: Download a video or playlist using yt-dlp using task spooler
#       to queue the downloads.

cmdname="$( basename "$0" )"
history=~/.local/share/yt-dlp/download.history
runtime_dir="$XDG_RUNTIME_DIR/${cmdname}"

# Task Spooler
export TMPDIR="${runtime_dir}/ts"
export TS_MAXFINISHED=12
mkdir -m 0700 -p $TMPDIR
ts -S 2

_dependency(){ command -v "$1" > /dev/null || { printf 'error: %s command not found\nplease install the needed dependencies\n' "$1"; exit 1; }; }
_dependency "yt-dlp"
_dependency "ts"

_ts_run_cmd(){
    yt-dlp "${1}" || notify-send 'Download Failed!' "$(2)"
}

_ts_add_cmd(){
    # use yt-dlp to get download info before adding to task spooler
    yt-dlp --ignore-config --quiet --skip-download "${1}" \
        --exec-before-download "ts -L %(webpage_url_domain)q \
        ${cmdname} --ts-run-cmd '${1}' %(title)q; \
        notify-send 'Add Download to Queue!' %(title)q"
}

_ts_fzf_list(){
    ts -l | sed "1d;s/[[:space:]].*]${cmdname} --ts-run-cmd / /"
}

_ts_menu(){
    _ts_fzf_list | \
            fzf -d' ' --with-nth='3..' --preview='ts -c {1}' \
            --preview-window='bottom,25%,nowrap,follow' \
            --bind="alt-q:execute(ts -k {1};ts -r {1}),alt-K:execute(ts -k {1}),alt-r:execute(
                ts -k {1};
                ts -r {1};
                ${cmdname} {2};
                ),return:reload(${cmdname} --ts-fzf-list),alt-o:execute($BROWSER {2}
                ),alt-u:execute(ts -u {1}),alt-i:execute(ts -i {1};echo '$sep';read),alt-c:execute(ts -c {1};read),alt-p:execute(printf 'pid: %s' \"\$(ts -p {1})\";read)"
}

case "$1" in
    --ts-run-cmd) shift; _ts_run_cmd "$@" ;; # not supposed to be run by user
    --ts-fzf-list) shift; _ts_fzf_list "$@" ;; # not supposed to be run by user
    -a|--add) shift; _ts_add_cmd "$@" ;;
    -t|--ts) shift; ts "$@" ;;
    -m|--ts-menu) _ts_menu ;;
    *) _ts_add_cmd "$@" ;;
esac
